<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi des actions</title>
<style>
  table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
  th { background-color: #f2f2f2; }
  input { width: 80px; }
</style>
</head>
<body>

<h1>Suivi des actions</h1>

<input type="text" id="symbol" placeholder="Symbole ex: AAPL, TTE.PA">
<button onclick="addSymbol()">Ajouter</button>

<table id="watchlistTable">
  <thead>
    <tr>
      <th>Symbole</th>
      <th>Nom</th>
      <th>Cours (â‚¬/$)</th>
      <th>Nombre</th>
      <th>Dividendes</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const API_KEY = 'BUJ9ONXMDU2BK43K'; // Ta clÃ© AlphaVantage
let watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];

// --- ðŸ”¹ RÃ©cupÃ¨re le nom de la sociÃ©tÃ© depuis OVERVIEW ---
async function getCompanyName(symbol) {
    try {
        const response = await fetch(`https://www.alphavantage.co/query?function=OVERVIEW&symbol=${symbol}&apikey=${API_KEY}`);
        const data = await response.json();
        if (data && data.Name) {
            return data.Name;
        }
    } catch (e) {
        console.error("Erreur rÃ©cupÃ©ration nom :", e);
    }
    return symbol; // fallback si pas trouvÃ©
}

// --- ðŸ”¹ Met Ã  jour le tableau principal ---
async function updateWatchlistTable() {
    const tbody = document.querySelector("#watchlistTable tbody");
    tbody.innerHTML = '';

    for (let i = 0; i < watchlist.length; i++) {
        const item = watchlist[i];
        let price = '-';
        let name = item.name || item.symbol || '-';

        // Si le nom n'est pas encore connu, on le rÃ©cupÃ¨re via OVERVIEW
        if (!item.name && item.symbol) {
            item.name = await getCompanyName(item.symbol);
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
        }

        // RÃ©cupÃ©ration du cours actuel
        if (item.symbol) {
            try {
                const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${item.symbol}&apikey=${API_KEY}`);
                const data = await response.json();
                if (data['Global Quote'] && data['Global Quote']['05. price']) {
                    price = parseFloat(data['Global Quote']['05. price']).toFixed(2);
                }
            } catch (e) {
                console.error(e);
            }
        }

        tbody.innerHTML += `
            <tr>
                <td>${item.symbol || '-'}</td>
                <td>${item.name || '-'}</td>
                <td>${price}</td>
                <td><input type="number" min="0" value="${item.quantity || 0}" onchange="updateQuantity(${i}, this.value)"></td>
                <td><input type="number" min="0" value="${item.dividends || 0}" onchange="updateDividends(${i}, this.value)"></td>
                <td><button onclick="removeSymbolByIndex(${i})">Supprimer</button></td>
            </tr>
        `;
    }
}

// --- ðŸ”¹ Ajouter un symbole ---
async function addSymbol() {
    const symbolInput = document.getElementById('symbol');
    const symbol = symbolInput.value.toUpperCase().trim();
    if (!symbol) return alert("Symbole invalide.");
    
    // RÃ©cupÃ¨re le nom complet une seule fois Ã  lâ€™ajout
    const name = await getCompanyName(symbol);
    watchlist.push({ symbol, name, quantity: 0, dividends: 0 });
    localStorage.setItem('watchlist', JSON.stringify(watchlist));
    symbolInput.value = '';
    updateWatchlistTable();
}

// --- ðŸ”¹ Supprimer par index ---
function removeSymbolByIndex(index) {
    watchlist.splice(index, 1);
    localStorage.setItem('watchlist', JSON.stringify(watchlist));
    updateWatchlistTable();
}

// --- ðŸ”¹ Met Ã  jour la quantitÃ© ---
function updateQuantity(index, value) {
    watchlist[index].quantity = parseFloat(value) || 0;
    localStorage.setItem('watchlist', JSON.stringify(watchlist));
}

// --- ðŸ”¹ Met Ã  jour les dividendes ---
function updateDividends(index, value) {
    watchlist[index].dividends = parseFloat(value) || 0;
    localStorage.setItem('watchlist', JSON.stringify(watchlist));
}

// --- ðŸ”¹ DÃ©marrage ---
updateWatchlistTable();
</script>

</body>
</html>
